<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Consultas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="page-container">
        <h1>Minhas Consultas</h1>

        <!-- Navigation -->
        <div class="logoutButtonContainer">
            <a href="{{ url_for('logout') }}" class="logoutButton">Logout</a>
        </div>

        <!-- Search Form -->
        <div class="searchContainer">
            <form id="searchForm">
                <input type="text" id="search_query" name="search_query" placeholder="Digite sua busca..." required>
                <button type="submit" class="search-btn">Buscar</button>
            </form>
        </div>

        <!-- Appointments Table -->
        <div class="appointments-container">
            <table id="appointmentsTable" class="users-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Hora</th>
                        <th>Status</th>
                        <th>Detalhes</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for consulta in consultas %}
                    <tr data-id="{{ consulta.id }}">
                        <td>{{ consulta.data }}</td>
                        <td>{{ consulta.hora }}</td>
                        <td>{{ consulta.status }}</td>
                        <td>{{ consulta.detalhes }}</td>
                        <td>
                            <button class="edit-btn">Editar</button>
                            <button class="delete-btn">Excluir</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <style>
                .appointments-container {
                    border: 1px solid #dee2e6;
                    border-radius: 4px;
                    padding: 20px;
                }
            </style>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="popup {% if category %}{{ category }}{% endif %}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <script>
        $(document).ready(function() {
            // Enable edit mode for appointments
            $(document).on('click', '.edit-btn', function() {
                const row = $(this).closest('tr');
                const cells = row.find('td:not(:last-child)'); // Ignore last column (actions)
                cells.each(function() {
                    const cell = $(this);
                    const text = cell.text();
                    cell.html(`<input type="text" value="${text}">`);
                });

                // Replace edit button with save and cancel buttons
                const actionCell = row.find('td:last-child');
                actionCell.html(`
                    <button class="save-btn">Salvar</button>
                    <button class="cancel-btn">Cancelar</button>
                `);
            });

            // Cancel edit
            $(document).on('click', '.cancel-btn', function() {
                const row = $(this).closest('tr');
                const cells = row.find('td:not(:last-child)');
                cells.each(function() {
                    const cell = $(this);
                    const input = cell.find('input');
                    cell.text(input.val());
                });

                // Restore edit button
                const actionCell = row.find('td:last-child');
                actionCell.html(`<button class="edit-btn">Editar</button>`);
            });

            // Save edited appointment
            $(document).on('click', '.save-btn', function() {
                const row = $(this).closest('tr');
                const id = row.data('id');
                const data = row.find('td:eq(0) input').val();
                const hora = row.find('td:eq(1) input').val();
                const status = row.find('td:eq(2) input').val();
                const detalhes = row.find('td:eq(3) input').val();

                $.ajax({
                    url: '/client/consultas/atualizarconsulta',
                    type: 'POST',
                    data: {
                        consulta_id: id,
                        data: data,
                        hora: hora,
                        status: status,
                        detalhes: detalhes
                    },
                    dataType: 'json',
                    success: function(response) {
                        try {
                            if (response.status === 'success') {
                                // Reload page after successful update
                                location.reload();
                            } else {
                                alert('Erro ao atualizar consulta: ' + response.error);
                            }
                        } catch (e) {
                            console.error('Error:', e);
                            alert('Erro ao processar resposta do servidor');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX error:', error);
                        alert('Erro ao atualizar consulta. Tente novamente.');
                    }
                });
            });

            // Delete appointment
            $(document).on('click', '.delete-btn', function() {
                if (!confirm('Tem certeza que deseja excluir esta consulta?')) {
                    return;
                }

                const row = $(this).closest('tr');
                const id = row.data('id');

                $.ajax({
                    url: '/client/consulta/deletarconsulta',
                    type: 'POST',
                    data: { consulta_id: id },
                    success: function(response) {
                        if (response.status === 'success') {
                            // Remove row from table
                            row.remove();
                        } else {
                            alert('Erro ao excluir consulta: ' + response.error);
                        }
                    },
                    error: function() {
                        alert('Erro ao excluir consulta. Tente novamente.');
                    }
                });
            });

            // Search appointments
            $('#searchForm').on('submit', function(event) {
                event.preventDefault();
                const query = $('#search_query').val();
                
                if (!query) {
                    alert('Por favor, preencha o campo de busca.');
                    return;
                }

                $.ajax({
                    url: '/client/consulta/search',
                    type: 'POST',
                    data: { query: query },
                    success: function(response) {
                        if (response.error) {
                            alert(response.error);
                            return;
                        }

                        const tableBody = $('#appointmentsTable tbody');
                        tableBody.empty();

                        response.results.forEach(consulta => {
                            const tr = $('<tr>').data('id', consulta.id);
                            tr.append(
                                $('<td>').text(consulta.data),
                                $('<td>').text(consulta.hora),
                                $('<td>').text(consulta.status),
                                $('<td>').text(consulta.detalhes),
                                $('<td>').html('<button class="edit-btn">Editar</button> <button class="delete-btn">Excluir</button>')
                            );
                            tableBody.append(tr);
                        });
                    },
                    error: function() {
                        alert('Erro ao buscar consultas. Tente novamente.');
                    }
                });
            });
        });
    </script>
</body>
</html>
